<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>GiftWise.</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link rel="stylesheet" href="assets/css/main.css?v=3.4">
    <script src="./js/app.js"></script>
</head>

<body>
    <header class="header-area header-style-5">
        <div class="header-bottom sticky-bar sticky-white-bg" id="headertop">
        </div>
    </header>

    <main class="main">
        <div class="footer-bottom"></div>
        <section class="mt-100 mb-60">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="product-detail accordion-detail">
                            <div class="row mb-50">
                                <div class="col-md-6 col-sm-12 col-xs-12">
                                    <div class="detail-gallery">
                                        <!-- MAIN SLIDES -->
                                        <div class="product-image-slider">
                                            <figure class="border-radius-10">
                                                <img src="" id="imageURL" alt="product image">
                                            </figure>
                                        </div>
                                    </div>
                                    <!-- End Gallery -->
                                </div>
                                <div class="col-md-6 col-sm-12 col-xs-12">
                                    <div class="detail-info">
                                        <h2 class="title-detail" id="productName"></h2>
                                        <div class="product-detail-rating">
                                            <div class="pro-details-brand">
                                                <span id="brandName"></a></span>
                                            </div>
                                            <div>
                                                <i class="fi-rs-heart" id="addToFavourite"></i>
                                                <img src="./assets/imgs/theme/icons8-heart-30.png"
                                                    id="removeFavourite" />
                                            </div>
                                        </div>
                                        <div class="clearfix product-price-cover">
                                            <div class="product-price primary-color float-left">
                                                <ins><span class="text-brand" id="giftCardPrice">$120.00</span></ins>
                                                <!-- <ins><span class="old-price font-md ml-15">$200.00</span></ins> -->
                                                <!-- <span class="save-price  font-md color3 ml-15">25% Off</span> -->
                                            </div>
                                        </div>
                                        <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                                        <div class="short-desc mb-30">
                                            <p id="description1"></p>
                                        </div>

                                        <div class="short-desc mb-30" id="offersDetails">

                                        </div>

                                        <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                        <div class="detail-extralink">

                                            <!-- <div class="product-extra-link2">
                                                <button type="submit" class="button button-add-to-cart" data-bs-toggle="modal" data-bs-target="#exampleModal">Buy now</button>
                                            </div> -->

                                            <div class="product-extra-link2">
                                                <button type="submit" class="button button-add-to-cart"
                                                    id="BuyNowButton">Buy now</button>
                                            </div>
                                        </div>

                                    </div>
                                    <!-- Detail Info -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-10 m-auto entry-main-content">
                                    <h2 class="section-title style-1 mb-30">Description</h2>
                                    <div class="description mb-50">
                                        <p id="description"></p>

                                        <hr class="wp-block-separator is-style-dots">

                                        <h4 class="mt-30">Steps to redeem</h4>
                                        <hr class="wp-block-separator is-style-wide">
                                        <p id="stepsToRedeem"></p>
                                        <hr class="wp-block-separator is-style-dots">
                                        <h4 class="mt-30">Terms and condition</h4>
                                        <hr class="wp-block-separator is-style-wide">
                                        <p id="termsAndConditions"></p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

            <!-- Modal -->
            <div class="modal fade" id="placeOrder" tabindex="-1" aria-labelledby="placeOrderLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="placeOrderLabel">Checkout</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div>
                                <div class="table-responsive">
                                    <table class="table shopping-summery text-center clean">
                                        <thead>
                                            <tr class="main-heading">
                                                <th scope="col">Name</th>
                                                <th scope="col">Price</th>
                                                <th scope="col">Quantity</th>
                                                <th scope="col">Discount</th>
                                                <th scope="col">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="product-des product-name">
                                                    <h5 class="product-name" id="checkoutProductName"></h5>
                                                </td>
                                                <td class="price" data-title="Price"><span id="checkoutPrice"> </span>
                                                </td>
                                                <td class="text-center" data-title="Stock">
                                                    <div class="detail-qty border radius  m-auto">
                                                        <span class="qty-val">1</span>
                                                    </div>
                                                </td>
                                                <td class="text-right" data-title="Cart">
                                                    <span id="checkoutDiscount"></span>
                                                </td>
                                                <td class="text-right" data-title="Cart">
                                                    <span id="checkoutTotalAmount"></span>
                                                </td>
                                            </tr>


                                        </tbody>
                                    </table>

                                    <div>
                                       
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input type="text" placeholder="Enter Promo Code..." id="checkPromocode">
                                    <p id="errorMessage" style="color: red; margin-left: 10px;"></p>
                                </div>
                                <div class="form-group">
                                    
                                    <button class="btn  btn-md" name="applypromocode" id="applyPromocode">Apply
                                        Coupon</button>
                                    <button class="btn  btn-md" name="removePromocode"
                                        id="removePromocode">Remove</button>
                                </div>
                                <div id="userRewards">
                                    
                                </div>
                                <div>
                                <label for="cardNumber">Card Number:</label>
                                <input type="text" id="cardNumber" name="cardNumber" placeholder="Enter card number" maxlength="20" value="4532-7207-8239-3654" required>
                                
                                <label for="expiry">Expiry Date:</label>
                                <input type="text" id="expiry" name="expiry" placeholder="MM/YY" maxlength="5" pattern="\d{2}/\d{2}" value="09/26" title="Please enter a valid expiry date in MM/YY format" required>

                                <label for="cvv">CVV:</label>
                                <input type="text" id="cvv" name="cvv" placeholder="CVV" maxlength="4" pattern="\d{3,4}" value="003" title="Please enter a valid CVV" required>
                            </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="placeOrderButton" type="button" class="btn btn-primary">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="loginScreen" tabindex="-1" aria-labelledby="loginScreen" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                    <div class="modal-content">
                        <div class="modal-body" style="text-align: center;">
                            <div>
                                <p> To purchase a gift card, you must either log in or create a new account. </p>
                                <a href="./page-login.html"><button type="button"
                                        class="btn btn-primary">Login</button></a>
                                <a href="./page-register.html"><button type="button" class="btn btn-primary">Sign
                                        Up</button></a>

                            </div>
                        </div>
                        <div class="modal-footer">

                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer class="main" id="footer">

    </footer>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor JS-->
    <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="assets/js/plugins/slick.js"></script>
    <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="assets/js/plugins/wow.js"></script>
    <script src="assets/js/plugins/jquery-ui.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="assets/js/plugins/magnific-popup.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/waypoints.js"></script>
    <script src="assets/js/plugins/counterup.js"></script>
    <script src="assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="assets/js/plugins/images-loaded.js"></script>
    <script src="assets/js/plugins/isotope.js"></script>
    <script src="assets/js/plugins/scrollup.js"></script>
    <script src="assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="assets/js/plugins/jquery.theia.sticky.js"></script>
    <!-- Template  JS -->
    <script src="./assets/js/main.js?v=3.4"></script>
    <script src="./assets/js/shop.js?v=3.4"></script>
    <script src="./js/header.js"></script>
    <script src="./js/footer.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const idProduct = urlParams.get('idProduct');
        let currentDiscount = 0;
        let rewardPointsDiscount = 0;
        localStorage.setItem('remainingPoints', localStorage.getItem('rewardPoints'))
        if (idProduct.length == 0) {
            window.location.href = "./index.html";
        }
        // Function to calculate the discounted amount
        function calculateDiscountedAmount(totalAmount, discountPercentage) {
            // Convert the discount percentage to decimal
            const discountDecimal = discountPercentage / 100;

            // Calculate the discounted amount
            const discountedAmount = totalAmount * discountDecimal;
            return discountedAmount;
        }
        $('#removePromocode').hide()
        localStorage.setItem("idProduct", idProduct)
        $('#addToFavourite').hide();
        $('#removeFavourite').hide();
        function useRewards(checkoutamount) {
            const individualProduct = localStorage.getItem('individualProduct')
            const rewardPoints = localStorage.getItem('rewardPoints')
            rewardPointsDiscount = Math.floor(rewardPoints / 100);
            if(rewardPointsDiscount>checkoutamount-currentDiscount){
                rewardPointsDiscount = checkoutamount-currentDiscount
            }
            let remainingPoints = rewardPoints - (rewardPointsDiscount * 100);
            currentDiscount += rewardPointsDiscount;
            localStorage.setItem('remainingPoints', remainingPoints)
            localStorage.setItem('rewardPointsDiscount', rewardPointsDiscount)
            $('#checkoutPrice').empty()
            $('#checkoutDiscount').empty()
            $('#checkoutTotalAmount').empty()
            $('#remainingPoints').empty()
            let [product] = JSON.parse(individualProduct)
  
            $('#checkoutPrice').append(`$${product.amount}`)
            $('#checkoutDiscount').append(`$${currentDiscount}`)
            $('#remainingPoints').append(`${localStorage.getItem('remainingPoints')}`)
            $('#checkoutTotalAmount').append(`$${+product.amount - currentDiscount}`)
            $('#removeRewards').show()
            $('#useRewards').hide()
        }

        function removeRewards() {
            const individualProduct = localStorage.getItem('individualProduct')
            const rewardPointsDiscount = localStorage.getItem('rewardPointsDiscount')
            const remainingPoints = localStorage.getItem('remainingPoints')
            localStorage.setItem('remainingPoints', remainingPoints + (rewardPointsDiscount * 100))
            localStorage.removeItem('rewardPointsDiscount');

            currentDiscount -= rewardPointsDiscount;
            $('#checkoutPrice').empty()
            $('#checkoutDiscount').empty()
            $('#checkoutTotalAmount').empty()
            let [product] = JSON.parse(individualProduct)
  
            $('#checkoutPrice').append(`$${product.amount}`)
            $('#checkoutDiscount').append(`$${currentDiscount}`)
            $('#checkoutTotalAmount').append(`$${+product.amount - currentDiscount}`)
            $('#removeRewards').hide()
            $('#useRewards').show()
        };
        $('#applyPromocode').click(function () {
            let offers = JSON.parse(localStorage.getItem('offers'));
            console.log("offers>>>>", offers)
            let record = offers.find(function (ele) {
                console.log("$('#checkPromocode').val()", ele.name, $('#checkPromocode').val())
                return ele.name == $('#checkPromocode').val()
            })
            console.log("record>>>", record)
            const individualProduct = localStorage.getItem('individualProduct')

            if (record && record.name) {
                
                $('#checkoutPrice').empty()
                $('#checkoutDiscount').empty()
                $('#checkoutTotalAmount').empty()

                let [product] = JSON.parse(individualProduct)
                let discount = calculateDiscountedAmount(product.amount, record.discountInPercentage)
                const discount1 = currentDiscount + discount
                $('#checkoutPrice').append(`$${product.amount}`)
                $('#checkoutDiscount').append(`$${discount1}`)
                $('#checkoutTotalAmount').append(`$${+product.amount - discount1}`)
                $("#checkPromocode").prop("disabled", true);
                $('#removePromocode').show()
                $('#applyPromocode').hide()
                currentDiscount = currentDiscount + discount;
            } else {
                $("#errorMessage").append("Invalid Promocode");
                setTimeout(function () {
                    $("#errorMessage").empty("");
                }, 3000); // 3000 milliseconds = 3 seconds
            }
        })
        $('#removePromocode').click(function () {

            const individualProduct = localStorage.getItem('individualProduct')
            $('#checkoutPrice').empty()
            $('#checkoutDiscount').empty()
            $('#checkoutTotalAmount').empty()
            let offers = JSON.parse(localStorage.getItem('offers'));
            let record = offers.find(function (ele) {
                console.log("$('#checkPromocode').val()", ele.name, $('#checkPromocode').val())
                return ele.name == $('#checkPromocode').val()
            })
            let [product] = JSON.parse(individualProduct)
            let discount = calculateDiscountedAmount(product.amount, record.discountInPercentage)
            const discount1 = currentDiscount - discount
            $('#checkoutPrice').append(`$${product.amount}`)
            $('#checkoutDiscount').append(`$${discount1}`)
            $('#checkoutTotalAmount').append(`$${+product.amount - discount1}`)
            $("#checkPromocode").prop("disabled", false);
            $('#checkPromocode').val('')
            $('#removePromocode').hide()
            $('#applyPromocode').show()
            currentDiscount = currentDiscount - discount;
        })
        function getFavourites() {
            var accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                return new Promise((resolve, reject) => {


                    $.ajax({
                        type: 'GET',
                        url: favoriteAPI,
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        },
                        contentType: 'application/json',
                        success: function (response) {
                            console.log("res", response);
                            if (response.status === 401) {
                                alert("Unauthorized");
                                logout();
                                window.location.href = 'page-login.html';
                            } else if (response.status !== 200) {
                                console.error('Error:', response);
                                alert(response.errorMessage);
                            } else {
                                if (response.payload && response.payload.some(va => va.idProduct == idProduct)) {
                                    console.log("IF>>>>>")
                                    $('#addToFavourite').hide()
                                    $('#removeFavourite').show()
                                } else {

                                    $('#addToFavourite').show()
                                    $('#removeFavourite').hide()
                                }
                            }
                        },
                        error: function (error) {
                            reject(reject)
                        }
                    });
                })
            }
        }
        function getPromocode() {
            $.ajax({
                type: 'GET',
                url: `${promocodeAPI}?idProduct=${idProduct}`,
                contentType: 'application/json',
                success: function (response) {
                    if (response.status !== 200) {
                        console.log(response)
                    } else {
                        processPromocodeResponse(response)
                    }
                },
                error: function (error) {
                }
            });
        }
        function getProduct() {
            $.ajax({
                type: 'GET',
                url: productAPI + `/${idProduct}`,
                contentType: 'application/json',
                success: function (response) {

                    if (response.status !== 200) {
                        console.log(response)
                    } else {
                        processData(response)
                    }
                },
                error: function (error) {
                    console.error('error:', error);
                }
            });
        }
        function processPromocodeResponse(response) {
            $('#offersDetails').empty()
            localStorage.setItem('offers', JSON.stringify(response.payload))
            const offers = response.payload.map((element, idx) => {
                return `<p> ${idx + 1}. Unlock savings with <u>${element.name}</u> promo code! Get ${element.discountInPercentage}% off now.</p>`
            });
            if (offers.length)
                $('#offersDetails').append(`<div>Offers:</div>
            <div id="offerList">
                ${offers.join("\n")}
            </div>`)

        }
        $('#BuyNowButton').click(function () {

            var accessToken = localStorage.getItem('accessToken');
            if (!accessToken || `${accessToken}`.length == 0) {
                $("#loginScreen").modal('show'); // Show modal
            } else {
                $('#checkoutProductName').empty()
                $('#checkoutPrice').empty()
                $('#checkoutDiscount').empty()
                $('#checkoutTotalAmount').empty()
                $('#checkPromocode').empty()
                $('#userRewards').empty()

                const individualProduct = localStorage.getItem('individualProduct')
                let [product] = JSON.parse(individualProduct)
                $('#checkoutProductName').append(product.productName)
                $('#checkoutPrice').append(`$${product.amount}`)
                $('#checkoutDiscount').append(`$0`)
                $('#checkoutTotalAmount').append(`$${product.amount}`)
                const rewardPoints = localStorage.getItem('rewardPoints')
                if (rewardPoints > 100 && product.amount > 0){
                    $('#userRewards').append(`<div class="form-group">
                                    <div id="useRewards"><a onclick='useRewards(${product.amount})'> Use My Rewards </a>
                                    (Available points : ${localStorage.getItem('rewardPoints')})</div>
                                    <div id="removeRewards" style='display: none;'>
                                    <a onclick='removeRewards()'> Remove rewards </a>
                                    (Remaining points : <span id="remainingPoints"></span>)
                                    </div>
                                </div>`)   
                }
                $("#placeOrder").modal('show'); // Show modal
            }
        })

        function detectCardType(cardNumber) {
            // Check if the card number starts with 4 (Visa) or 5 (Mastercard)
            if (cardNumber.startsWith('4')) {
                return 1;
            } else if (cardNumber.startsWith('5')) {
                return 2;
            } else {
                return 'Unknown'; // Or you can handle other card types here
            }
        }
    

        $('#placeOrderButton').click(function () {
            
            let accessToken = localStorage.getItem('accessToken');
            let promoCode = $('#checkPromocode').prop('disabled') ? $('#checkPromocode').val() : "";
            const rewardPoints = localStorage.getItem('rewardPoints')
            const remainingPoints = localStorage.getItem('remainingPoints')
            const bonuspoints = calculateDiscountedAmount($('#checkoutTotalAmount').text().split("$").join(''), 1);

            const idPaymentMethod = detectCardType($('#cardNumber').val())
        
            bonus = parseInt(remainingPoints) + parseInt(bonuspoints);
            
            // (:idUser,:idGiftcard,:status,:discount,:totalAmount,:startDate,:endDate,:orderDatetime)
            let orderPostData = {
                idProduct: idProduct,
                status: 'Success',
                discount: +$('#checkoutDiscount').text().split("$").join(''),
                totalAmount: +$('#checkoutTotalAmount').text().split("$").join(''),
                userRewards: {
                    rewardPoints: bonus
                },
                idPaymentMethod
            }

            $.ajax({
                type: 'POST',
                url: orderAPI,
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                contentType: 'application/json',
                data: JSON.stringify(orderPostData),
                success: function(response) {
                    console.log("inside success",response);
                    if(response.status === 401){
                        alert("Unauthorized, Please login again");
                        logout();
                        window.location.href = 'page-login.html';
                    }else if(response.status !== 200){
                        alert(response.errorMessage);
                        $('#placeOrder').modal('hide');
                    }else{
                        $('#placeOrder').modal('hide');
                        localStorage.setItem('rewardPoints', orderPostData.userRewards.rewardPoints)
                        localStorage.setItem('remainingPoints', orderPostData.userRewards.rewardPoints)
                        alert('Order placed successfully!');
                        window.location.href = 'page-account.html?href=orders';
                    }
                },
                error: function(error) {
                    alert('Something went wrong, please try again!');
                    $('#placeOrder').modal('hide');
                }
            })

            console.log(JSON.stringify(orderPostData));
        })

        $('#removeFavourite').click(function () {
            var accessToken = localStorage.getItem('accessToken');
            $.ajax({
                type: 'DELETE',
                url: favoriteAPI + `/${idProduct}`,
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function (response) {
                    console.log('Product removed from favorites:', response);
                    $('#addToFavourite').show()
                    $('#removeFavourite').hide()
                },
                error: function (error) {
                    console.error('Error removing product from favorites:', error);
                    alert("Error while removing from favourites");
                }
            });
        })

        $('#addToFavourite').click(function () {
            var accessToken = localStorage.getItem('accessToken');
            $.ajax({
                type: 'POST',
                url: favoriteAPI,
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    idProduct: localStorage.getItem('idProduct')
                }),
                success: function (response) {
                    console.log('Product removed from favorites:', response);
                    $('#addToFavourite').hide()
                    $('#removeFavourite').show()
                },
                error: function (error) {
                    console.error('Error removing product from favorites:', error);
                    alert("Error while removing from favourites");
                }
            });
        })


        function processData(response) {
            getPromocode()
            getFavourites()
            localStorage.setItem('individualProduct', JSON.stringify(response.payload))
            $('#description').empty()
            $('#description1').empty()
            $('#stepsToRedeem').empty()
            $('#termsAndConditions').empty()
            $('#productName').empty()
            $('#brandName').empty()
            $('#giftCardPrice').empty()
            response.payload.forEach(element => {
                $("#imageURL").attr("src", element.imageURL);
                $('#description').append(element.description)
                $('#description1').append(element.description)
                $('#stepsToRedeem').append(element.stepsToRedeem)
                $('#termsAndConditions').append(element.termsAndConditions)
                $('#productName').append(element.productName)
                $('#brandName').append(`Brand: ${element.brandName}`)
                $('#giftCardPrice').append(`$${element.amount}`)
            });
        }

        getProduct()
        $('#submitOrder').submit(function (e) {
            e.preventDefault();

            var formData = {
                idProduct,

            };

            $.ajax({
                type: 'POST',
                url: orderAPI,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {

                    if (response.status !== 200) {
                        $('#errorMessage').text(response.errorMessage);
                    } else {

                    }
                },
                error: function (error) {
                    console.error('error:', error);
                }
            });
        });
        $('#removeRewards').hide()

    </script>
    </script>
</body>

</html>